<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forgot Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
     $(window).on('load', function () {
    const params = new URLSearchParams(window.location.search);
    if (params.get('showModal') === 'true') {
        setTimeout(() => {
            $('#forgotPasswordModal').modal('show');
        }, 100); // Slight delay ensures modal is initialized
    }
});

    </script>
</head>

<body class="bg-light d-flex justify-content-center align-items-center vh-100">

    <!-- Forgot Password Modal -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Forgot Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="step1">
                        <label>Email:</label>
                        <input type="email" id="forgotEmail" class="form-control mb-2" placeholder="Enter your email">
                        <button class="btn btn-primary w-100" id="sendForgotOtp">Send OTP</button>
                    </div>

                    <div id="step2" style="display:none;">
                        <label>Enter OTP:</label>
                        <input type="text" id="forgotOtp" class="form-control mb-2"
                            placeholder="Enter the OTP received">
                        <button class="btn btn-success w-100" id="verifyForgotOtp">Verify OTP</button>
                    </div>

                    <div id="step3" style="display:none;">
                        <label>Enter New Password:</label>
                        <input type="password" id="newPassword" class="form-control mb-2" placeholder="New password">
                        <div id="passwordStrength" class="mb-2 text-muted"></div>
                        <button class="btn btn-success w-100" id="changePasswordBtn">Change Password</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let forgotEmailGlobal = "";
        let forgotOtpServer = "";

        $("#sendForgotOtp").click(function () {
            const email = $("#forgotEmail").val().trim();
            if (!email) {
                alert("Enter your email.");
                return;
            }

            $.ajax({
                url: "http://localhost:2005/send-otp2",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ email }),
                success: function (data) {
                    forgotEmailGlobal = email;
                    forgotOtpServer = data.otp;
                    $("#step1").hide();
                    $("#step2").show();
                    alert("OTP sent to your email.");
                },
                error: function () {
                    alert("Error sending OTP.");
                }
            });
        });

        $("#verifyForgotOtp").click(function () {
            const entered = $("#forgotOtp").val().trim();
            console.log(entered);
            console.log(forgotOtpServer);
            if (entered === String(forgotOtpServer)) {
                $("#step2").hide();
                $("#step3").show();
            } else {
                alert("Invalid OTP");
            }
        });

        $("#changePasswordBtn").click(function () {
            const newPwd = $("#newPassword").val().trim();
            if (!newPwd) {
                alert("Enter a new password.");
                return;
            }

            const strengthResult = checkPasswordStrength(newPwd);
            if (strengthResult.label === "Weak") {
                alert("Password is too weak. Use a mix of uppercase, lowercase, number, and special characters.");
                return;
            }

            $.ajax({
                url: "http://localhost:2005/update-password2",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ email: forgotEmailGlobal, newPassword: newPwd }),
                success: function (res) {
                    alert("Password changed successfully!");
                    $("#forgotPasswordModal").modal("hide");
                },
                error: function () {
                    alert("Error updating password.");
                }
            });
        });
        function checkPasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;           // Length
            if (/[A-Z]/.test(password)) strength++;         // Uppercase
            if (/[a-z]/.test(password)) strength++;         // Lowercase
            if (/\d/.test(password)) strength++;            // Number
            if (/[@$!%*?&#]/.test(password)) strength++;    // Special char

            if (strength <= 2) return { label: "Weak", color: "text-danger" };
            if (strength <= 4) return { label: "Medium", color: "text-warning" };
            return { label: "Strong", color: "text-success" };
        }

        // Realtime feedback while typing
        $("#newPassword").on("input", function () {
            const pwd = $(this).val().trim();
            const { label, color } = checkPasswordStrength(pwd);
            $("#passwordStrength").text(`Strength: ${label}`).removeClass().addClass(color);
        });

    </script>
</body>

</html>