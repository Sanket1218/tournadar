<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body onload="showUser();" class="bg-light">

<div class="row w-100">
  <div class="col-md-12 bg-primary text-white text-center py-3">
    <h4 class="m-0">www.tournadar.com</h4>
  </div>
</div>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2 bg-danger text-white text-center py-2 mb-4">
      <h2>Player Profile Details</h2>
    </div>
  </div>

  <div class="col-md-8 offset-md-2">
    <form action="/upload-player-profile" id="playerForm" enctype="multipart/form-data" class="row g-3" method="post">

      <div class="col-12">
        <div class="row g-2 align-items-end">
          <div class="col-md-8">
            <label class="form-label">Email ID</label>
            <input type="email" class="form-control" id="txtEmail" name="emailid">
            <span id="errEmail"></span>
          </div>

          <div class="col-md-4 d-grid">
            <label class="form-label d-none d-md-block">&nbsp;</label>
            <button type="button" class="btn btn-success" id="btnSearch">Search</button>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Upload Aadhar Front</label>
        <input type="file" class="form-control" name="aadhar_pic" id="aadharPic" onchange="showPrev(aadharPic, prevAadhar)">
        <input type="hidden" name="oldAadharUrl" id="oldAadharUrl">
      </div>
    <!--
      <div id="aadharStatus" style="display: none; color: blue; font-weight: bold;">
      <span class="spinner-border spinner-border-sm"></span>
       Reading from Aadhaar card...
      </div>
    -->


      <div class="col-md-6">
        <label class="form-label">Upload Profile Pic</label>
        <input type="file" class="form-control" name="profile_pic" id="profilePic" onchange="showPrev(profilePic, prevProfile)">
        <input type="hidden" name="oldProfileUrl" id="oldProfileUrl">
      </div>

      <div class="col-md-6 text-center">
        <img src="pics/customer.jpg" width="100" height="100" id="prevAadhar">
      </div>
      <div class="col-md-6 text-center">
        <img src="pics/customer.jpg" width="100" height="100" id="prevProfile">
      </div>

      <div class="col-12">
        <label class="form-label">Name</label>
        <input type="text" class="form-control" name="name">
      </div>

      <div class="col-md-6">
        <label class="form-label">Date of Birth</label>
       <input type="text" name="dob" class="form-control" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Gender</label>
       <input type="text" name="gender" class="form-control" />
      </div>

      <div class="col-12">
        <label class="form-label">Address</label>
        <textarea class="form-control" name="address"></textarea>
      </div>

      <div class="col-md-6">
        <label class="form-label">Contact</label>
        <input type="text" class="form-control" name="contact">
      </div>

      <div class="col-md-6">
        <label class="form-label">Games You Play</label>
        <input type="text" class="form-control" name="games_you_play">
      </div>

      <div class="col-12">
        <label class="form-label">Other Info</label>
        <textarea class="form-control" name="other_info"></textarea>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-primary">Upload Data</button>
        <button type="submit" formaction="/modify-player-profile" class="btn btn-primary">Modify</button>
      </div>

    </form>
  </div>
</div>

<nav class="navbar bg-primary mt-5 w-100 py-3">
  <div class="container-fluid justify-content-center">
    <h4 class="text-white m-0">www.tournadar.com</h4>
  </div>
</nav>

<script>
function showPrev(fileInput, imgElem) {
  if (fileInput.files && fileInput.files[0]) {
    var reader = new FileReader();
    reader.onload = function (e) {
      imgElem.src = e.target.result;
    };
    reader.readAsDataURL(fileInput.files[0]);
  }
}

$(document).ready(function(){
  $("#btnSearch").click(function(){
    let obj = {
      type: "get",
      url: "/fetch-player-profile",
      data: {
        txtEmail: $("#txtEmail").val()
      }
    };

    $.ajax(obj).then(
      function(responseJsonAry){
        if(responseJsonAry.length > 0) {
          let rec = responseJsonAry[0];

          $("[name='name']").val(rec.name);
          let dob = rec.dob ? rec.dob.substring(0, 10) : "";
        $("[name='dob']").val(dob);

          $("[name='gender']").val(rec.gender);
          $("[name='address']").val(rec.address);
          $("[name='contact']").val(rec.contact);
          $("[name='games_you_play']").val(rec.games_you_play);
          $("[name='other_info']").val(rec.other_info);

          $("#prevAadhar").attr("src", rec.aadhar_pic);
          $("#prevProfile").attr("src", rec.profile_pic);

          $("#oldAadharUrl").val(rec.aadhar_pic);
          $("#oldProfileUrl").val(rec.profile_pic);
        }
        else {
          alert("No record found");
        }
      },
      function(err){
        alert(err.message);
      }
    );
  });
});


</script>
</script>`
  <script>
    function showUser()
    {
      let activeUser=localStorage.getItem("activeUser");
      document.getElementById("txtEmail").value=activeUser;
    }
  </script>
 
 <script>
  
  $("#aadharPic").change(function () {
    var formData = new FormData();
    formData.append("aadharPic", $("#aadharPic")[0].files[0]);

    // Show the full screen overlay
    $("#aadharOverlay").show();

    $.ajax({
      url: "/read-aadhar-ai",
      type: "post",
      data: formData,
      processData: false,
      contentType: false,
     success: function (data) {
  $("#aadharOverlay").hide(); // hide overlay

  if (data.name) $("[name='name']").val(data.name);
  
  if (data.dob) {
    let parts = data.dob.split("/");
    if (parts.length === 3) {
      let formattedDOB = `${parts[2]}-${parts[1]}-${parts[0]}`; // Convert to YYYY-MM-DD
      $("[name='dob']").val(formattedDOB);
    } else {
      $("[name='dob']").val(data.dob); // fallback
    }
  }

  if (data.gender) $("[name='gender']").val(data.gender);
},

      error: function (err) {
        $("#aadharOverlay .overlay-content").html("<div class='text-danger fw-bold'> Error reading Aadhaar card</div>");
        setTimeout(() => $("#aadharOverlay").fadeOut(), 2000);
      }
    });
  });


  // You can reuse this function later if you want to pass image URL
  function RajeshBansalKaChirag(imgurl) {
    const prompt = "Read the text on picture and tell all the information in adhaar card and give output STRICTLY in JSON format {adhaar_number:'', name:'', gender:'', dob: ''}. Dont give output as string.";

    fetch(imgurl)
      .then(res => res.arrayBuffer())
      .then(buffer => {
        return model.generateContent([
          {
            inlineData: {
              data: btoa(String.fromCharCode(...new Uint8Array(buffer))),
              mimeType: "image/jpeg",
            }
          },
          prompt
        ]);
      })
      .then(aiResult => {
        const rawText = aiResult.response.text().replace(/```json|```/g, "").trim();
        const jsonData = JSON.parse(rawText);
        if (jsonData.name) $("[name='name']").val(jsonData.name);
        if (jsonData.dob) $("[name='dob']").val(jsonData.dob);
        if (jsonData.gender) $("[name='gender']").val(jsonData.gender);
      });
  }
</script>
<!-- Aadhaar Loading Overlay -->
<div id="aadharOverlay" style="display: none;">
  <div class="overlay-bg"></div>
  <div class="overlay-content">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-3 fw-bold fs-5 text-primary">Reading from Aadhaar card...</div>
  </div>
</div>
<style>
  #aadharOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1050;
  }
  .overlay-bg {
    background: rgba(255, 255, 255, 0.8);
    position: absolute;
    width: 100%;
    height: 100%;
  }
  .overlay-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
</style>



</body>
</html>
